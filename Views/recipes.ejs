<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <%- include('meta.ejs'); %>

</head>

<body>

    <%- include('header.ejs', {user:user}) %>
        <!-- Subheader Start -->
        <div class="metro_subheader dark-overlay dark-overlay-2"
            style="background-image: url(assets/img/banners/banner-1.jpg)">
            <div class="container">
                <div class="metro_subheader-inner">
                    <h1>Recipe Details</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/index">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Recipe Details</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        <!-- Subheader End -->

        <!-- Post Content Start -->
        <div class="section metro_post-single">
            <div class="container">

                <div class="row1">
                    <div class="col-lg-8">

                        <!-- Content  -->
                        <div class="metro_post-single-wrapper metro_recipe-single-wrapper">

                            <h2 class="entry-title text-center" id="recipeName"></h2>

                            <div class="metro_post-single-thumb">
                                <img id="recipeImage" src="" alt="post">
                            </div>

                            <!-- Entry Content Start -->
                            <div class="entry-content">
                                <span class="metro_post-meta">

                                    <i id="authorName" class="far fa-user"></i>
                                    <i id="totalTime" class="far fa-clock"></i>
                                </span>

                                <p id="recipeDescription">

                                </p>

                                <p id="recipeInstructions">
                                </p>

                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="metro_nutritional-facts text-left">
                                            <h4>Nutrition</h4>
                                            <ul>
                                                <li> Calories: <span id="calories"></span> </li>
                                                <li> Sugar: <span id="sugar"></span> </li>
                                                <li> Protein: <span id="protein"></span> </li>
                                                <li> Fat: <span id="fat"></span> </li>
                                                <li> Carbs: <span id="carbs"></span> </li>
                                                <li> Cholestorol: <span id="cholestorol"></span> </li>
                                                <li> Fiber: <span id="fiber"></span> </li>
                                                <li> Saturated Fat: <span id="satFat"></span> </li>
                                                <li> Sodium: <span id="sodium"></span> </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="metro_ingredients text-left">
                                            <h4>Ingredients</h4>
                                            <ul id="ingredient">
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Entry Content End -->

                        </div>

                        <!-- Comments Form -->
                        <div class="metro_comments-list">
                            <h4>Our Comments</h4>
                            <ul id="commentItem">
                            </ul>
                        </div>

                        <!-- Comments -->
                        <div class="metro_comments-form">

                            <h4>Leave a Comment</h4>

                            <form id="commentForm">
                                <div class="form-group">
                                    <textarea id="reviewDesc" class="form-control" placeholder="Type your review..."
                                        name="review" rows="7"></textarea>
                                </div>
                                <div class="form-group d-flex" style="text-align: left;">
                                    <label for="rate d-inline-block" style="font-size: 1.5em;">Rating:</label>
                                    <div class="rate" id="rate">
                                        <input type="radio" id="star5" name="rate" value="5" hidden />
                                        <label for="star5" title="text">5 stars</label>
                                        <input type="radio" id="star4" name="rate" value="4" hidden />
                                        <label for="star4" title="text">4 stars</label>
                                        <input type="radio" id="star3" name="rate" value="3" hidden />
                                        <label for="star3" title="text">3 stars</label>
                                        <input type="radio" id="star2" name="rate" value="2" hidden />
                                        <label for="star2" title="text">2 stars</label>
                                        <input type="radio" id="star1" name="rate" value="1" hidden />
                                        <label for="star1" title="text">1 star</label>
                                    </div>
                                </div>
                                <% if(user){ %>
                                    <input type="text" id="userID" name="userID" value="<%-user.id%>" hidden />
                                    <input type="text" id="userName" name="userName" value="<%-user.username%>"
                                        hidden />
                                    <% } else { %>
                                        <input type="text" id="userID" name="userID" value="0" hidden />
                                        <input type="text" id="userName" name="userName" value="Anonymous" hidden />
                                        <%}%>
                                            <button type="submit" class="metro_btn-custom primary" name="button">Send
                                                Comment</button>
                            </form>
                        </div>

                    </div>

                </div>
                <!-- Edit Modal -->
                <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="updateModalLabel">Edit Comments</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="updateCommentForm">
                                    <div class="form-group">
                                        <textarea id="reviewDescription" class="form-control"
                                            placeholder="Type your review..." name="review" rows="7"></textarea>
                                    </div>
                                    <!-- Pass in input data to modal-->
                                    <div class="form-group">
                                        <input type="text" id="reviewID" name="reviewID" hidden>
                                    </div>
                                    <div class="form-group d-flex" style="text-align: left;">
                                        <div class="form-group">
                                            <label for="rating d-inline-block" style="font-size: 1.5em;">Rating:</label>
                                            <br>
                                            <input type="number" min="0" max="5" id="rating" name="Rating"
                                                style="width: 10em;" placeholder="Rate from 0 to 5"><br>
                                        </div>
                                    </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary" name="button">Save Changes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Update Modal-->
                <!-- Delete Modal -->
                <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLabel">Delete Comment</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="deleteCommentForm">
                                    <!-- Pass in input data to modal-->
                                    <div class="form-group">
                                        <input type="text" id="deleteReviewID" name="deleteReviewID" hidden>
                                    </div>
                                    <p>Do you want to delete this comment?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                                <button type="submit" class="btn btn-primary" name="button">Yes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Delete Modal-->
            </div>
        </div>
        <!-- Product Content End -->

        <%- include('footer.ejs') %>

            <!-- Vendor Scripts -->
            <script src="/assets/js/plugins/jquery-3.4.1.min.js"></script>
            <script src="/assets/js/plugins/popper.min.js"></script>
            <script src="/assets/js/plugins/waypoint.js"></script>
            <script src="/assets/js/plugins/bootstrap.min.js"></script>
            <script src="/assets/js/plugins/jquery.magnific-popup.min.js"></script>
            <script src="/assets/js/plugins/jquery.slimScroll.min.js"></script>
            <script src="/assets/js/plugins/imagesloaded.min.js"></script>
            <script src="/assets/js/plugins/jquery.steps.min.js"></script>
            <script src="/assets/js/plugins/jquery.countdown.min.js"></script>
            <script src="/assets/js/plugins/isotope.pkgd.min.js"></script>
            <script src="/assets/js/plugins/slick.min.js"></script>
            <script src="/assets/js/plugins/ion.rangeSlider.min.js"></script>
            <script src="/assets/js/plugins/jquery.zoom.min.js"></script>


            <!-- Organization Scripts -->
            <script src="/assets/js/main.js"></script>

            <script>
                var rating = 0;
                var urlParams = new URLSearchParams(window.location.search);
                var userID = document.getElementById('userID').value;
                console.log(userID);
                var userName = document.getElementById('userName').value;
                console.log(userName);
                window.onload = function () {


                    if (urlParams.has('recipeID')) {
                        var query = urlParams.get('recipeID')
                        console.log(query)

                        $.ajax({
                            type: "POST",
                            url: "/recipes/details",
                            data: {
                                recipeID: query
                            },
                            success: function (result) {
                                console.log(result)
                                var image = '/assets/img/noImageAvailable.png';
                                // console.log(result[0].image.split(", ")[0])
                                if (result[0].image) {
                                    image = result[0].image.split(", ")[0]
                                }
                                $('#recipeName').append(result[0].recipeName);
                                $('#recipeImage').prop("src", image);
                                $('#authorName').append(" " + result[0].authorName + " ");
                                $('#totalTime').append(" " + result[0].totalTime);
                                $('#recipeDescription').append(" " + result[0].description);
                                $('#recipeInstructions').append(" " + result[0].instructions.replaceAll(".,", "</br>"));
                                $('#calories').append(result[0].calories);
                                $('#sugar').append(result[0].sugarContent);
                                $('#protein').append(result[0].proteinContent);
                                $('#fat').append(result[0].fatContent);
                                $('#carbs').append(result[0].carboContent);
                                $('#cholestorol').append(result[0].cholestorolContent);
                                $('#fiber').append(result[0].fiberContent);
                                $('#satFat').append(result[0].satFatContent);
                                $('#sodium').append(result[0].sodium);
                                $('#ingredient').append("<li>" + result[0].ingredientName.replaceAll(", ", "</li><li>"));

                                if (result[0].RecipeDetails[0]) {
                                    for (i = 0; i < result[0].RecipeDetails.length; i++) {
                                        $("#commentItem").append(
                                            '<li class="comment-item">' +
                                            '<img src="assets/img/people/avatar-0.png" alt="comment author">' +
                                            '<div class="comment-body">' +
                                            '<h5 id="reviewerName">' + result[0].RecipeDetails[i].reviewAuthorName + '</h5>' +
                                            '<span id="reviewDate">' + result[0].RecipeDetails[i].dateModified + '</span>' +
                                            '<p id="review">' + result[0].RecipeDetails[i].reviewDesc + '</p></div></li>')
                                        if (userName == result[0].RecipeDetails[i].reviewAuthorName) {
                                            $("#commentItem").append(
                                                '<button type="submit" class="btn btn-primary" style="margin: 10px 50px;" id="editComment" data-toggle="modal" data-target="#updateModal" onclick="editComment(' + result[0].RecipeDetails[i].reviewID + ')")>Edit</button>' +
                                                '<button type="submit" class="btn btn-danger" id="deleteComment" data-toggle="modal" data-target="#deleteModal" onclick="deleteComment(' + result[0].RecipeDetails[i].reviewID + ')">Delete</button>')
                                        }
                                    }
                                }
                                else {
                                    $("#commentItem").append('<h5 id="reviewerName">No Review</h5>')
                                }
                            }
                        });
                    }
                }

                $('#rate').click(function () {
                    for (i = 1; i < 6; i++) {
                        var stringVal = 'star' + i.toString();
                        if (document.getElementById(stringVal).checked) {
                            rating = document.getElementById(stringVal).value
                        }
                    }
                });

                commentForm.onsubmit = async (e) => {
                    console.log("HIT HERE COMMENT AJAX")
                    e.preventDefault();

                    $.ajax({
                        type: "POST",
                        url: "recipes/",
                        data: {

                            recipeID: parseInt(urlParams.get('recipeID')),
                            //To be Changed to user when implemented jessica login
                            reviewAuthorID: userID,
                            reviewAuthorName: userName,
                            //Change Ends
                            rating: rating,
                            reviewDesc: $("#reviewDesc").val()
                        },
                        error: function (xhr, status, err) {
                            alert(status + " " + err);
                        },
                        success: function (result) {
                            window.location.reload();
                        }
                    });
                }

                // Pass In ReviewID to delete Modal
                function deleteComment(id) {
                    var review = id;
                    console.log(review);
                    document.getElementById('deleteReviewID').value = review;
                }

                // Delete Comment
                deleteCommentForm.onsubmit = async (e) => {
                    e.preventDefault();
                    console.log($("#deleteReviewID").val());
                    console.log("HIT HERE DELETE AJAX");
                    $.ajax({
                        type: "POST",
                        url: "recipes/delete",
                        data: {
                            reviewID: parseInt($("#deleteReviewID").val())
                        },
                        error: function (xhr, status, err) {
                            alert(status + " " + err);
                        },
                        success: function (result) {
                            console.log(result)
                            window.location.reload();
                        }
                    });
                }

                // Pass In ReviewID to Modal
                function editComment(ID) {
                    var review = ID;
                    console.log(review);
                    document.getElementById('reviewID').value = review;
                };


                // Update Comment
                updateCommentForm.onsubmit = async (e) => {
                    console.log($("#reviewID").val());
                    console.log($("#rating").val());
                    console.log($("#reviewDescription").val());
                    console.log("HIT HERE UPDATE COMMENT AJAX");

                    // Explain prevent default
                    // The preventDefault() method of the Event interface tells the user agent 
                    //that if the event does not get explicitly handled, 
                    // its default action should not be taken as it normally would be.
                    e.preventDefault();
                    $.ajax({
                        type: "POST",
                        url: "recipes/update",
                        data: {
                            reviewID: parseInt($("#reviewID").val()),
                            rating: parseInt($("#rating").val()),
                            reviewDesc: $("#reviewDescription").val()
                        },
                        error: function (xhr, status, err) {
                            alert(status + " " + err);
                        },
                        success: function (result) {
                            window.location.reload();
                        }
                    });
                }
            </script>

</body>

</html>